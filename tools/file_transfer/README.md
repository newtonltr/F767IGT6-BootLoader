# 文件传输客户端

用于向单片机传输bin文件的TCP客户端工具。

## 功能特点

- 支持TCP连接，默认端口7000
- 自动验证bin文件格式和大小（最大200KB）
- 按512字节分包传输，支持CRC16校验
- 智能重连和重试机制
- 实时进度显示，清晰显示每包传输状态
- 优化的传输速度控制

## 使用方法

1. 运行程序：
```bash
python file_transfer_client.py
```

2. 按提示输入：
   - 服务器IP地址（支持IPv4格式验证）
   - 端口号（默认7000，范围1-65535）
   - bin文件路径（支持拖拽文件或手动输入）

3. 程序会自动：
   - 验证文件格式和大小
   - 建立TCP连接并等待服务器确认
   - 分包传输文件
   - 实时显示传输进度和状态
   - 等待单片机完成IAP烧录流程
   - 显示烧录进度和最终结果

## 错误处理

- **连接失败**: 自动重试3次，失败后询问是否继续
- **传输失败**: 自动重试10次，失败后可选择继续、重新开始或退出
- **网络错误**: 详细显示连接重置、连接断开等网络问题
- **单片机错误**: 直接显示单片机返回的原始错误信息

## 传输控制

- **成功发送间隔**: 每包成功发送后等待10ms
- **重试间隔**: 失败重试之间等待100ms
- **连接超时**: 10秒连接超时
- **自动重连**: 连接断开时自动尝试重连

## IAP流程

程序完成文件传输后会自动进入IAP烧录阶段：

1. **文件传输完成**: 最后一包接收`start_program`响应
2. **开始烧录**: 单片机开始将文件写入APP区域  
3. **进度显示**: 实时显示已写入的字节数
4. **烧录完成**: 接收`program_complete`消息，程序结束

## 注意事项

- 确保bin文件小于200KB，程序会自动检查文件大小
- 服务器端需要支持file_transfer_protocol_t协议
- 支持按字节对齐的结构体（使用`__packed`或`__attribute__((packed))`）
- 程序会显示详细的传输统计信息，包括传输速度
- 整个IAP流程完成前不要中断程序，等待烧录完成

## 协议格式

```c
// 使用按字节对齐，总大小530字节
struct __attribute__((packed)) file_transfer_protocol_t
{
    uint32_t pack_index;    // 这一包数据的序号
    uint32_t total_bytes;   // 总数据大小  
    uint32_t total_packs;   // 总包数
    uint32_t data_size;     // 这一包数据的大小
    uint8_t data[512];      // 数据
    uint16_t crc16;         // 校验码
};
```

## CRC16算法

使用与单片机端相同的CRC16算法（crc_compute_lsb），确保校验一致性。

## 兼容性

- Python 3.6+
- 支持Windows、Linux、macOS
- 无需额外依赖库，使用标准库实现 